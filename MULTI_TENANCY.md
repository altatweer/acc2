# دليل تطوير منصة متعددة المستأجرين (Multi-Tenancy)

## نظرة عامة

تم تحضير نظام المحاسبة (AurSuite) ليكون قابلاً للربط مع منصة SaaS في المستقبل. هذا الدليل يشرح كيفية إعداد وتطوير نظام يدعم ميزة Multi-Tenancy.

## التغييرات التي تم إجراؤها

1. **إضافة حقل `tenant_id` للجداول**:
   - تم إنشاء ملف هجرة لإضافة حقل `tenant_id` إلى كل الجداول المتعلقة بالبيانات التي ستكون خاصة بكل مستأجر.
   - الحقل `nullable` حالياً لتسهيل الانتقال للنظام الجديد لاحقاً.

2. **إنشاء Trait للتعامل مع Multi-Tenancy**:
   - تم إنشاء `BelongsToTenant` trait لتطبيقه على النماذج التي تحتاج للعمل مع نظام متعدد المستأجرين.
   - يوفر Trait آليات تلقائية لتقييد الاستعلامات حسب `tenant_id` وتعيين `tenant_id` تلقائياً عند إنشاء سجلات جديدة.

3. **إضافة إعدادات لتفعيل/تعطيل Multi-Tenancy**:
   - تم إضافة خيار `multi_tenancy_enabled` في ملف التكوين.
   - تم إضافة متغير بيئي `MULTI_TENANCY_ENABLED` للتحكم في تشغيل الميزة.

4. **إنشاء Service Provider مخصص**:
   - تم إنشاء `MultiTenancyServiceProvider` لإعداد البنية التحتية للنظام متعدد المستأجرين.
   - تم تعليق التنفيذ الفعلي ليتم تفعيله لاحقاً عند ربط النظام بمنصة SaaS.

## كيفية استخدام Multi-Tenancy في النظام

### للنماذج الجديدة

عند إنشاء نموذج جديد يرتبط بمستأجر محدد، قم بإضافة Trait `BelongsToTenant`:

```php
use App\Traits\BelongsToTenant;

class YourModel extends Model
{
    use HasFactory, BelongsToTenant;
    
    // ...
}
```

### للاستعلامات الغير مقيدة بمستأجر

إذا كنت بحاجة للوصول إلى بيانات من جميع المستأجرين (مثلاً في لوحة تحكم المشرف الرئيسي)، استخدم دالة `allTenants()`:

```php
// للحصول على بيانات جميع المستأجرين
$allAccounts = Account::allTenants()->get();
```

## تفعيل Multi-Tenancy

لتفعيل النظام متعدد المستأجرين، اتبع الخطوات التالية:

1. قم بتعديل ملف `.env` وتعيين `MULTI_TENANCY_ENABLED=true`.

2. قم بتحديث `MultiTenancyServiceProvider` لتنفيذ منطق تحديد `tenant_id` المناسب لتطبيقك.

3. قم بتطوير منطق تحديد المستأجر من خلال تنفيذ واحدة من الاستراتيجيات التالية:
   - تحديد المستأجر من خلال المجال الفرعي (subdomain).
   - تحديد المستأجر من خلال مسار URL.
   - تحديد المستأجر من خلال رمز مميز (token) أو جلسة.

## ملاحظات هامة للمطورين

1. **تحديث البيانات الحالية**: قبل تفعيل Multi-Tenancy بالكامل، يجب تحديث البيانات الموجودة لتعيين `tenant_id` المناسب.

2. **اختبار النظام**: تأكد من اختبار التطبيق بشكل شامل في وضع Multi-Tenancy للتأكد من عدم تسرب البيانات بين المستأجرين.

3. **واجهات الاستخدام**: تأكد من تحديث واجهات المستخدم للتعامل مع سياق المستأجر الحالي إذا لزم الأمر.

4. **الأمان**: كن حذراً جداً عند كتابة استعلامات مخصصة لتأكد من تطبيق قيود المستأجر دائماً. 