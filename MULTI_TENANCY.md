# نظام تعدد المستأجرين (Multi-Tenancy) في نظام المحاسبة

## نظرة عامة

تم تصميم نظام المحاسبة ليعمل كمنصة SaaS (Software as a Service) مع دعم لتعدد المستأجرين، مما يسمح للنظام بخدمة العديد من الشركات (المستأجرين) من خلال قاعدة بيانات واحدة مع الحفاظ على استقلالية البيانات الكاملة بين المستأجرين.

## التصميم الحالي

النظام حالياً يعمل في وضع المستأجر الواحد (Single-Tenant) ولكن تم تجهيزه بالكامل للتحول إلى نظام متعدد المستأجرين (Multi-Tenant) عند الحاجة. ميزات تعدد المستأجرين غير مفعلة افتراضياً ويمكن تفعيلها من خلال إعداد `MULTI_TENANCY_ENABLED=true` في ملف `.env`.

## المكونات الرئيسية

### 1. جدول المستأجرين (`tenants`)

تم إنشاء جدول `tenants` لتخزين معلومات كل مستأجر (شركة) في النظام:

- **معلومات المستأجر**: الاسم، النطاق الفرعي، البريد الإلكتروني، إلخ.
- **معلومات الاشتراك**: نوع الخطة، تاريخ البدء والانتهاء، إلخ.
- **الإعدادات**: خيارات مخصصة لكل مستأجر (اللغة، المنطقة الزمنية، إلخ).

### 2. حقل `tenant_id` في كل الجداول

تم إضافة حقل `tenant_id` إلى جميع جداول النظام لتحقيق عزل البيانات بين المستأجرين:

- **جداول المستخدمين والأدوار**: `users`, `roles`, `permissions`, إلخ.
- **جداول البيانات الأساسية**: `accounts`, `vouchers`, `transactions`, إلخ.
- **جداول العلاقات**: الجداول التي تربط بين الكيانات المختلفة.

### 3. Trait لعزل الاستعلامات (`BelongsToTenant`)

تم إنشاء Trait يطبق على جميع النماذج (Models) لضمان عزل البيانات:

- **إضافة Global Scope**: يضيف تلقائياً شرط `tenant_id` إلى جميع الاستعلامات.
- **التعبئة التلقائية**: يعبئ `tenant_id` تلقائياً عند إنشاء سجلات جديدة.
- **العلاقة مع المستأجر**: يعرّف علاقة مع نموذج المستأجر.

### 4. Service Provider لإدارة المستأجرين

تم إنشاء `MultiTenancyServiceProvider` لإدارة تحديد المستأجر الحالي:

- **تحديد المستأجر الحالي**: من المستخدم الحالي أو الجلسة أو النطاق الفرعي.
- **تأمين الصلاحيات**: يمنع المستخدمين من الوصول إلى بيانات مستأجر آخر.
- **تسجيل Singleton**: لتوفير `tenant_id` الحالي في جميع أنحاء التطبيق.

## إعداد النظام للاستخدام

### الوضع الحالي (مستأجر واحد)

- في الوضع الحالي، يعمل النظام كتطبيق عادي مع `tenant_id=1` لجميع البيانات.
- تم إعداد مستأجر افتراضي في النظام بالفعل من خلال TenantSeeder.
- لا يوجد أي تأثير على الأداء أو طريقة عمل النظام.

### التحول إلى نظام متعدد المستأجرين

لتفعيل وضع تعدد المستأجرين، اتبع الخطوات التالية:

1. تغيير إعداد `MULTI_TENANCY_ENABLED=true` في ملف `.env`.
2. إنشاء واجهة إدارية لإدارة المستأجرين وخطط الاشتراك.
3. تعديل نظام تسجيل الدخول للتعامل مع النطاقات الفرعية.
4. تعديل Middleware للتأكد من تحديد المستأجر الصحيح.

## مميزات خطط الاشتراك

تم إنشاء نظام لإدارة خطط الاشتراك مع دعم للميزات المختلفة:

- **جدول خطط الاشتراك**: يخزن معلومات كل خطة والميزات المتاحة.
- **جدول ميزات المستأجر**: يتتبع الميزات المفعلة لكل مستأجر.
- **جدول إحصائيات الاستخدام**: يتتبع استخدام الموارد لكل مستأجر.

## المزايا

1. **عزل البيانات**: بيانات كل مستأجر معزولة تماماً عن المستأجرين الآخرين.
2. **إدارة مركزية**: يمكن إدارة جميع المستأجرين من لوحة تحكم واحدة.
3. **تخصيص الميزات**: يمكن تخصيص الميزات المتاحة لكل مستأجر حسب خطة الاشتراك.
4. **توسع سهل**: يمكن إضافة مستأجرين جدد بسهولة دون الحاجة لإعداد قواعد بيانات منفصلة.

## الاستخدام في التطوير

للمطورين الذين يعملون على النظام، يجب اتباع هذه الممارسات:

1. **استخدام `BelongsToTenant` Trait**: تأكد من إضافة هذا الـ Trait إلى أي نموذج جديد يتم إنشاؤه.
2. **عدم الاعتماد المباشر على `tenant_id`**: استخدم دائماً `app('tenant_id')` للحصول على معرف المستأجر الحالي.
3. **اختبار في كلا الوضعين**: اختبر التغييرات في وضع المستأجر الواحد ووضع تعدد المستأجرين.

## التخطيط المستقبلي

- **واجهة إدارة المستأجرين**: إنشاء واجهة كاملة لإدارة المستأجرين وخطط الاشتراك.
- **نظام فوترة**: ربط النظام بنظام فوترة للتعامل مع دفعات الاشتراكات.
- **مقاييس الأداء**: إضافة مقاييس أداء لتتبع استخدام الموارد لكل مستأجر.
- **النسخ الاحتياطي المنفصل**: تمكين النسخ الاحتياطي لبيانات كل مستأجر بشكل منفصل. 