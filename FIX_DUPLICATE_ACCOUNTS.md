# إصلاح مشكلة الحسابات المكررة

## المشكلة
عند تثبيت النظام، يتم إنشاء الحسابات داخل حلقة العملات، مما يؤدي إلى تكرار الحسابات لكل عملة.

## الحل

### 1. إزالة التكرارات الموجودة

قم بتشغيل الأمر التالي لإزالة التكرارات:

```bash
# أولاً: عرض التكرارات فقط (dry-run)
php artisan accounts:remove-duplicates --dry-run

# ثم: حذف التكرارات فعلياً
php artisan accounts:remove-duplicates
```

**ملاحظة مهمة:**
- السكريبت يحتفظ بأول حساب (الأقدم) ويحذف الباقي
- إذا كان للحساب المكرر معاملات، سيتم نقلها تلقائياً إلى الحساب المحفوظ

### 2. إضافة Unique Constraint

بعد إزالة التكرارات، قم بتشغيل migration لإضافة unique constraint:

```bash
php artisan migrate
```

### 3. التحقق من النتيجة

```bash
# التحقق من عدم وجود تكرارات
php artisan accounts:remove-duplicates --dry-run
```

## الإصلاحات المطبقة

### 1. InstallController.php
- تم إصلاح `importChart()` لإنشاء الحسابات مرة واحدة فقط (خارج حلقة العملات)
- إضافة فحص للتكرار قبل الإنشاء
- الحسابات الآن متعددة العملات ولا تحتاج إلى تكرار لكل عملة

### 2. RemoveDuplicateAccounts Command
- أمر جديد لإزالة التكرارات
- يدعم dry-run للتحقق قبل الحذف
- ينقل المعاملات تلقائياً إلى الحساب المحفوظ

### 3. Migration
- إضافة unique constraint على `code` في جدول `accounts`
- منع التكرارات في المستقبل

## تدقيق شجرة الحسابات

بعد إزالة التكرارات، يمكنك:
1. فتح صفحة "شجرة الحسابات" للتحقق من الهيكل
2. التحقق من أن كل حساب له كود فريد
3. التأكد من أن العلاقات الهرمية صحيحة

## ملاحظات
- الحسابات متعددة العملات: لا حاجة لإنشاء حساب منفصل لكل عملة
- الكود فريد: كل حساب له كود فريد في النظام
- المعاملات: يتم نقلها تلقائياً عند حذف حساب مكرر

